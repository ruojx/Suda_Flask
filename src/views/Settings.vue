<!-- /src/Settings.vue -->
<template>
  <div class="container settings">
    <div class="head">
      <h1 class="title">è®¾ç½®</h1>
      <div class="actions">
        <button class="btn" @click="goBack">â† è¿”å›</button>
        <button class="btn" @click="resetToDefaults">é‡ç½®</button>
        <button class="btn primary" @click="saveAll">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>

    <!-- å¤–è§‚ä¸åå¥½ -->
    <section class="card">
      <h2 class="section-title">å¤–è§‚ä¸åå¥½</h2>
      <div class="grid-2">
        <div class="field">
          <label>ä¸»é¢˜</label>
          <select v-model="state.appearance.theme" class="input">
            <option value="system">è·Ÿéšç³»ç»Ÿ</option>
            <option value="light">äº®è‰²</option>
            <option value="dark">æš—è‰²</option>
          </select>
          <small class="muted">ä¿å­˜åä¼šç«‹å³åº”ç”¨åˆ°ç«™ç‚¹ã€‚</small>
        </div>
        <div class="field">
          <label>è¯­è¨€</label>
          <select v-model="state.appearance.locale" class="input">
            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            <option value="en-US">English</option>
          </select>
        </div>
      </div>
    </section>

    <!-- ä¸ªäººèµ„æ–™ -->
    <section class="card">
      <h2 class="section-title">ä¸ªäººèµ„æ–™</h2>
      <div class="grid-2">
        <div class="field">
          <label>æ˜µç§°</label>
          <input v-model="state.profile.name" class="input" placeholder="Your Name" />
        </div>
        <div class="field">
          <label>é‚®ç®±</label>
          <input v-model="state.profile.email" class="input" type="email" placeholder="you@example.com" />
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>æ‰€åœ¨åŸå¸‚</label>
          <input v-model="state.profile.location" class="input" placeholder="Tokyo / Shanghai" />
        </div>
        <div class="field">
          <label>èŒä½/è§’è‰²</label>
          <input v-model="state.profile.role" class="input" placeholder="Software Engineer" />
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>GitHub</label>
          <input v-model="state.profile.links.github" class="input" placeholder="https://github.com/yourname" />
        </div>
        <div class="field">
          <label>åšå®¢</label>
          <input v-model="state.profile.links.blog" class="input" placeholder="https://blog.example.com" />
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>LinkedIn</label>
          <input v-model="state.profile.links.linkedin" class="input" placeholder="https://linkedin.com/in/you" />
        </div>
        <div class="field">
          <label>å¤´åƒ URL</label>
          <input v-model="state.profile.avatar" class="input" placeholder="/src/assets/avatar.jpg æˆ–åœ¨çº¿é“¾æ¥" />
        </div>
      </div>
      <div class="field">
        <label>ä¸€å¥è¯ç­¾å</label>
        <input v-model="state.profile.subtitle" class="input" placeholder="å…¨æ ˆå¼€å‘ Â· Vue 3 & Spring Boot" />
      </div>
      <div class="field">
        <label>å¯¹å¤–å¯è§</label>
        <label class="switch">
          <input type="checkbox" v-model="state.profile.publicVisible">
          <span>å…¬å¼€å±•ç¤ºæˆ‘çš„åŸºç¡€èµ„æ–™</span>
        </label>
      </div>
    </section>

    <!-- é€šçŸ¥ -->
    <section class="card">
      <h2 class="section-title">é€šçŸ¥</h2>
      <div class="grid-3">
        <div class="field">
          <label class="switch">
            <input type="checkbox" v-model="state.notify.email">
            <span>é‚®ä»¶é€šçŸ¥</span>
          </label>
          <small class="muted">æ–°æ¶ˆæ¯ã€è¯„è®ºã€ç³»ç»Ÿå…¬å‘Šã€‚</small>
        </div>
        <div class="field">
          <label class="switch">
            <input type="checkbox" v-model="state.notify.inApp">
            <span>ç«™å†…é€šçŸ¥</span>
          </label>
          <small class="muted">å³ä¸Šè§’é“ƒé“›æ¨é€ã€‚</small>
        </div>
        <div class="field">
          <label>å‘¨æŠ¥æ—¶é—´</label>
          <input class="input" type="time" v-model="state.notify.digestAt" />
          <small class="muted">æ¯å‘¨ä¸€åœ¨æ­¤æ—¶é—´å‘é€æ€»ç»“ã€‚</small>
        </div>
      </div>
    </section>

    <!-- AI åŠŸèƒ½ -->
    <section class="card">
      <h2 class="section-title">AI åŠŸèƒ½</h2>
      <div class="grid-3">
        <div class="field">
          <label class="switch">
            <input type="checkbox" v-model="state.ai.autoAnswer">
            <span>å¯ç”¨ AI å›ç­”</span>
          </label>
          <small class="muted">åœ¨è§‚ç‚¹ä¸‹è‡ªåŠ¨ç”Ÿæˆå‚è€ƒå›ç­”ã€‚</small>
        </div>
        <div class="field">
          <label class="switch">
            <input type="checkbox" v-model="state.ai.compareOpinions">
            <span>AI è§‚ç‚¹å¯¹æ¯”</span>
          </label>
          <small class="muted">èšåˆä¼˜ç¼ºç‚¹ï¼Œç”Ÿæˆå¯¹ç…§è¡¨ã€‚</small>
        </div>
        <div class="field">
          <label class="switch">
            <input type="checkbox" v-model="state.ai.planGen">
            <span>AI è®¡åˆ’ç”Ÿæˆ</span>
          </label>
          <small class="muted">åŸºäºä¸»é¢˜äº§å‡ºè¡ŒåŠ¨æ¸…å•ã€‚</small>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>æ¨¡å‹æ¸©åº¦ (0â€“1)</label>
          <input class="input" type="number" step="0.05" min="0" max="1" v-model.number="state.ai.temperature" />
        </div>
        <div class="field">
          <label>æœ€å¤§è¾“å‡º Token</label>
          <input class="input" type="number" min="64" max="4096" v-model.number="state.ai.maxTokens" />
        </div>
      </div>
    </section>

    <!-- è´¦æˆ·ä¸å®‰å…¨ -->
    <section class="card">
      <h2 class="section-title">è´¦æˆ·ä¸å®‰å…¨</h2>
      <div class="grid-2">
        <div class="field">
          <label>åŒé‡éªŒè¯ (2FA)</label>
          <label class="switch">
            <input type="checkbox" v-model="state.security.enable2FA">
            <span>å¯ç”¨</span>
          </label>
        </div>
        <div class="field">
          <label>ä¼šè¯æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
          <input class="input" type="number" min="1" max="30" v-model.number="state.security.sessionTTL" />
        </div>
      </div>
      <div class="danger">
        <button class="btn danger-btn" @click="logoutAll">é€€å‡ºæ‰€æœ‰è®¾å¤‡</button>
        <small class="muted">å°†ä½¿æ‰€æœ‰å·²ç™»å½•ä¼šè¯å¤±æ•ˆã€‚</small>
      </div>
    </section>

    <footer class="footer">
      <button class="btn" @click="resetToDefaults">é‡ç½®</button>
      <button class="btn primary" @click="saveAll">ä¿å­˜</button>
    </footer>
  </div>
</template>

<script setup>
import { reactive, onMounted, watch, computed } from 'vue'

/** æœ¬åœ°æŒä¹…åŒ–é”® */
const LS_KEY = 'app.settings.v1'

/** é»˜è®¤è®¾ç½® */
const defaults = {
  appearance: {
    theme: 'system', // 'light' | 'dark' | 'system'
    locale: 'zh-CN'
  },
  profile: {
    name: 'Your Name',
    email: 'you@example.com',
    location: 'Tokyo / Shanghai',
    role: 'Software Engineer',
    subtitle: 'å…¨æ ˆå¼€å‘ Â· Vue 3 & Spring Boot',
    avatar: '/src/assets/avatar.jpg',
    publicVisible: true,
    links: {
      github: 'https://github.com/yourname',
      blog: '#',
      linkedin: '#'
    }
  },
  notify: {
    email: true,
    inApp: true,
    digestAt: '09:00'
  },
  ai: {
    autoAnswer: true,
    compareOpinions: true,
    planGen: true,
    temperature: 0.4,
    maxTokens: 1024
  },
  security: {
    enable2FA: false,
    sessionTTL: 7
  }
}

const state = reactive(structuredClone(defaults))

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(LS_KEY)
    if (raw) {
      const parsed = JSON.parse(raw)
      deepMerge(state, parsed)
    }
  } catch (e) {
    console.warn('[settings] load failed:', e)
  }
}

function saveAll() {
  localStorage.setItem(LS_KEY, JSON.stringify(state))
  applyTheme(state.appearance.theme)
  alert('å·²ä¿å­˜è®¾ç½®')
}

/** ä¸»é¢˜åº”ç”¨åˆ° <html> */
function applyTheme(theme) {
  let t = theme
  if (t === 'system') {
    t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }
  document.documentElement.style.colorScheme = t
}

/** é‡ç½®ä¸ºé»˜è®¤ */
function resetToDefaults() {
  deepMerge(state, structuredClone(defaults), true)
  saveAll()
}

/** è¿”å›ä¸Šä¸€é¡µï¼ˆè‹¥çˆ¶çº§ä½¿ç”¨ <Settings @back="..."> å¯æ”¹é€  emitï¼‰ */
function goBack() {
  history.length > 1 ? history.back() : null
}

/** é€€å‡ºæ‰€æœ‰è®¾å¤‡ï¼ˆæ¼”ç¤ºï¼‰ */
function logoutAll() {
  if (confirm('ç¡®å®šè¦é€€å‡ºæ‰€æœ‰è®¾å¤‡å—ï¼Ÿ')) {
    // è¿™é‡Œå¯è°ƒç”¨åç«¯ APIï¼š/api/account/logout-all
    alert('å·²è¯·æ±‚é€€å‡ºæ‰€æœ‰è®¾å¤‡ï¼ˆæ¼”ç¤ºï¼‰')
  }
}

/** æ·±åˆå¹¶å·¥å…· */
function deepMerge(target, src, replace = false) {
  for (const k of Object.keys(src)) {
    const v = src[k]
    if (v && typeof v === 'object' && !Array.isArray(v)) {
      if (!target[k] || replace) target[k] = {}
      deepMerge(target[k], v, replace)
    } else {
      target[k] = v
    }
  }
}

onMounted(() => {
  loadFromStorage()
  applyTheme(state.appearance.theme)
})

/** è·Ÿéšç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼ˆå½“é€‰æ‹©â€œè·Ÿéšç³»ç»Ÿâ€æ—¶ï¼‰ */
const media = window.matchMedia('(prefers-color-scheme: dark)')
media.addEventListener?.('change', () => {
  if (state.appearance.theme === 'system') applyTheme('system')
})
</script>

<style scoped>
.settings { padding-top: 24px; padding-bottom: 40px; }
.head { display:flex; align-items:center; gap:14px; margin-bottom:14px; }
.head .actions { margin-left:auto; display:flex; gap:10px; flex-wrap: wrap; }
.title { font-size:24px; margin:0; }
.card {
  margin: 16px 0;
  background: linear-gradient(180deg, color-mix(in oklab, var(--card) 92%, transparent), var(--card));
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 18px;
}
.section-title { margin:0 0 12px; font-size:18px; }
.grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
.grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; }
.field { display:flex; flex-direction:column; gap:8px; }
label { font-weight:600; }
.input {
  border:1px solid var(--border);
  background:linear-gradient(180deg, color-mix(in oklab, var(--card) 90%, transparent), var(--card));
  color:var(--text); padding:10px 12px; border-radius:12px; outline:none;
}
.input:focus { box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand) 25%, transparent); }
.switch { display:flex; align-items:center; gap:10px; }
.btn{
  border:1px solid var(--border); background:linear-gradient(180deg, color-mix(in oklab, var(--card) 90%, transparent), var(--card)); color:var(--text);
  padding:8px 14px; border-radius:12px; display:inline-flex; align-items:center; gap:8px; cursor:pointer; transition:.2s;
}
.btn:hover{ transform: translateY(-1px); }
.btn.primary{ background: linear-gradient(180deg, color-mix(in oklab, var(--brand) 25%, var(--card)), var(--card)); }
.danger{ margin-top:12px; display:flex; align-items:center; gap:10px; }
.danger-btn{ border-color:#ff5959; }
.footer{ display:flex; justify-content:flex-end; gap:10px; padding-top:10px; }

@media (max-width: 860px){
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  .head { flex-direction: column; align-items: flex-start; gap:8px; }
  .head .actions { margin-left:0; }
}
</style>
